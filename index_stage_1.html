<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Ciphered Circuit — Stage 1 Radio</title>
<meta name="theme-color" content="#0a0f14">
<style>
  :root{--bg:#0a0f14; --primary:#20ffe3; --accent:#ff5d73; --muted:#7bd4c9;}
  html,body{margin:0;padding:0;background:var(--bg);color:#e8fff9;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;height:100%;width:100%;}
  .container{display:flex;flex-direction:column;align-items:center;justify-content:center;width:100%;height:100%;padding:8px;}
  .radio{width:100%;max-width:520px;background:linear-gradient(145deg,#0d1218,#06090f);border:1px solid rgba(32,255,227,0.2);border-radius:18px;box-shadow:0 10px 30px rgba(0,0,0,0.6),inset 0 0 30px rgba(32,255,227,0.05);overflow:hidden;position:relative;}
  .scanlines:before{content:"";position:absolute;inset:0;background:repeating-linear-gradient(to bottom,rgba(0,0,0,0.15) 0,rgba(0,0,0,0.15) 2px,transparent 2px,transparent 4px);mix-blend-mode:overlay;pointer-events:none;}
  .bezel{padding:14px;}
  .header{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;}
  .badge{letter-spacing:.1em;font-weight:700;color:var(--primary);font-size:.9rem;text-shadow:0 0 6px rgba(32,255,227,0.6);}
  .tiny-led{width:8px;height:8px;border-radius:50%;background:#032c28;border:1px solid #1bf1d6;box-shadow:0 0 10px rgba(27,241,214,0.25) inset;}
  .screen{background:radial-gradient(110% 90% at 50% 10%,#0c2832 0%,#071a21 60%,#041014 100%);border:1px solid rgba(32,255,227,0.2);border-radius:14px;padding:12px;min-height:260px;position:relative;overflow:hidden;}
  .dial{height:5px;background:linear-gradient(90deg,rgba(32,255,227,0.2),rgba(32,255,227,0.8),rgba(32,255,227,0.2));border-radius:5px;margin:26px 0 8px;opacity:.85;position:relative;}
  .needle{position:absolute;top:-7px;width:2px;height:18px;background:var(--accent);box-shadow:0 0 10px rgba(255,93,115,0.65);transform:translateX(0);transition:transform 1.8s cubic-bezier(.19,1,.22,1);}
  .tune-readout{display:flex;justify-content:space-between;font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;font-size:.78rem;color:var(--muted);opacity:.9;}
  .big{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;font-size:clamp(1rem,4.8vw,1.35rem);text-align:center;text-shadow:0 0 10px rgba(32,255,227,0.55);}
  .statusrow{display:flex;justify-content:space-between;align-items:center;gap:12px;margin-top:4px;}
  .status{font-size:.78rem;color:var(--muted);}
  .station{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;font-weight:800;letter-spacing:.08em;color:#9fffee;text-shadow:0 0 10px rgba(32,255,227,.7);opacity:.95}
  .controls{display:flex;flex-wrap:wrap;gap:8px;justify-content:center;margin-top:12px;}
  button, a.btn{border:1px solid rgba(32,255,227,0.4);background:linear-gradient(160deg,rgba(32,255,227,0.15),rgba(32,255,227,0.04));color:#bafff3;padding:9px 13px;border-radius:999px;font-size:.95rem;font-weight:600;cursor:pointer;text-decoration:none;display:inline-block;}
  .footer{font-size:.78rem;color:var(--muted);display:flex;justify-content:space-between;margin-top:8px;}
  canvas#snow{position:absolute;inset:0;opacity:.2;pointer-events:none;}
  .hint{display:none;margin-top:10px;text-align:center;color:#b6fff3;font-size:.9rem}
  .toast{position:fixed;left:50%;top:18px;transform:translateX(-50%) scale(.95);background:#0c161a;border:1px solid rgba(118,255,168,.6);color:#dcffef;
    padding:10px 14px;border-radius:12px;box-shadow:0 14px 30px rgba(0,0,0,.5),0 0 30px rgba(118,255,168,.25);display:flex;align-items:center;gap:10px;opacity:0;pointer-events:none;transition:.35s ease; z-index:9999;}
  .toast.show{opacity:1;transform:translateX(-50%) scale(1);}
</style>
</head>
<body>
<div class="container">
  <div class="radio scanlines" id="radioRoot">
    <div class="bezel">
      <div class="header">
        <div class="badge">CIPHERED CIRCUIT // STAGE 1</div>
        <div class="tiny-led" id="led"></div>
      </div>
      <div class="screen">
        <canvas id="snow"></canvas>
        <div class="tune-readout"><div>VHF 108</div><div>UHF 470</div><div>UHF 698</div></div>
        <div class="dial"><div class="needle" id="needle"></div></div>
        <div class="big" id="readout">— Standby —</div>
        <div class="statusrow">
          <div class="status" id="status">Tap “Tune In” and raise your volume. Some phones require a tap to allow audio.</div>
          <div class="station" id="station">—</div>
        </div>
        <div class="hint" id="hint">Hint: The radio broadcasts the <em>coordinates</em> in Morse. Listen for numbers and N/W.</div>
      </div>
      <div class="controls">
        <button id="playBtn">▶︎ Tune In</button>
        <button id="replayBtn" disabled>↺ Replay</button>
        <button id="hintBtn">Show Hint</button>
        <a class="btn" id="logBtn" href="https://slewf0ot.github.io/Circuit-Cipher/index_stage_3.html?stage=Stage%201" target="_blank" rel="noopener">✎ Log Stage 1</a>
      </div>
      <div class="footer"><div>MODE: DECODE</div><div id="footerMsg">▮▮▯▯▯</div></div>
    </div>
  </div>
</div>

<div class="toast" id="toast">Logbook opened in a new tab.</div>

<script>
/* ================== Visual "CRT" static ================== */
const canvas=document.getElementById('snow'); const ctx=canvas.getContext('2d');
function sizeCanvas(){ const rect=canvas.getBoundingClientRect(); const dpr=Math.max(1,Math.floor(window.devicePixelRatio||1)); canvas.width=Math.round(rect.width*dpr); canvas.height=Math.round(rect.height*dpr); }
function drawSnow(){ const w=canvas.width,h=canvas.height; if(!w||!h)return; const img=ctx.createImageData(w,h); const data=img.data; for(let i=0;i<data.length;i+=4){ const v=Math.random()*255; data[i]=data[i+1]=data[i+2]=v; data[i+3]=255; } ctx.putImageData(img,0,0); }
function resizeAll(){ sizeCanvas(); drawSnow(); }
const ro=new ResizeObserver(resizeAll); ro.observe(canvas.parentElement); addEventListener('resize',resizeAll); resizeAll(); setInterval(drawSnow,60);

/* ================== Audio: dynamic sweeping static ================== */
let ac=null, staticNodes=null, staticPlaying=false;
function createStaticGraph(){
  if (!ac) ac = new (window.AudioContext||window.webkitAudioContext)();

  // white noise buffer loop
  const seconds = 2.0;
  const buffer = ac.createBuffer(1, Math.floor(ac.sampleRate*seconds), ac.sampleRate);
  const data = buffer.getChannelData(0);
  for (let i=0;i<data.length;i++) data[i] = (Math.random()*2-1)*0.5;

  const src = ac.createBufferSource(); src.buffer = buffer; src.loop = true;

  // band-pass sweep + tremolo (fading)
  const bp = ac.createBiquadFilter(); bp.type = 'bandpass'; bp.frequency.value = 700; bp.Q.value = 1.2;
  const lfo = ac.createOscillator(); lfo.frequency.value = 0.07;
  const depth = ac.createGain(); depth.gain.value = 1400; lfo.connect(depth); depth.connect(bp.frequency);
  const trem = ac.createOscillator(); trem.frequency.value = 0.6;
  const tremDepth = ac.createGain(); tremDepth.gain.value = 0.3; trem.connect(tremDepth);

  const gain = ac.createGain(); gain.gain.value = 0.24;
  tremDepth.connect(gain.gain);

  // random pop effect
  const popGain = ac.createGain(); popGain.gain.value = 1.0;
  const mix = ac.createGain();

  src.connect(bp); bp.connect(gain); gain.connect(mix);
  popGain.connect(mix); mix.connect(ac.destination);

  const popTimer = setInterval(()=>{
    if (!staticPlaying) return;
    const now = ac.currentTime;
    popGain.gain.cancelScheduledValues(now);
    popGain.gain.setValueAtTime(1.0, now);
    popGain.gain.exponentialRampToValueAtTime(0.08, now+0.01);
    popGain.gain.exponentialRampToValueAtTime(1.0, now+0.25);
  }, 900 + Math.random()*500);

  lfo.start(); trem.start(); src.start();

  staticNodes = {src, bp, gain, lfo, trem, depth, popGain, popTimer};
  staticPlaying = true;
}
function startStatic(){
  if (!ac) createStaticGraph();
  if (ac.state === 'suspended') ac.resume();
  if (!staticNodes) createStaticGraph();
  const now = ac.currentTime; const g = staticNodes.gain.gain;
  g.cancelScheduledValues(now); g.setValueAtTime(g.value, now); g.linearRampToValueAtTime(0.26, now+0.4);
  staticPlaying = true;
}
function stopStatic(fadeMs=600){
  if (!staticNodes || !staticPlaying) return;
  const now = ac.currentTime; const g = staticNodes.gain.gain;
  g.cancelScheduledValues(now); g.setValueAtTime(g.value, now); g.linearRampToValueAtTime(0.0001, now + fadeMs/1000);
  setTimeout(()=>{
    try { staticNodes.src.stop(); staticNodes.lfo.stop(); staticNodes.trem.stop(); } catch(e){}
    clearInterval(staticNodes.popTimer); staticNodes = null; staticPlaying = false;
  }, fadeMs+120);
}

/* ================== Morse generator (fully offline) ================== */
const MORSE = {
  'A':'.-','B':'-...','C':'-.-.','D':'-..','E':'.','F':'..-.','G':'--.','H':'....','I':'..','J':'.---','K':'-.-','L':'.-..','M':'--','N':'-.',
  'O':'---','P':'.--.','Q':'--.-','R':'.-.','S':'...','T':'-','U':'..-','V':'...-','W':'.--','X':'-..-','Y':'-.--','Z':'--..',
  '0':'-----','1':'.----','2':'..---','3':'...--','4':'....-','5':'.....','6':'-....','7':'--...','8':'---..','9':'----.'
};
function normalizeText(t){ return t.toUpperCase().replace(/[^A-Z0-9 ]+/g,' ').replace(/\s+/g,' ').trim(); }
function textToUnits(t){
  const DOT=1, DASH=3, GAP_ELEM=1, GAP_CHAR=3, GAP_WORD=7;
  const out=[]; let firstChar=true;
  for(const ch of t){
    if (ch===' '){ out.push([false,GAP_WORD]); firstChar=true; continue; }
    const code=MORSE[ch]; if (!code){ if(!firstChar) out.push([false,GAP_CHAR]); firstChar=false; continue; }
    if(!firstChar) out.push([false,GAP_CHAR]); firstChar=false;
    for(let i=0;i<code.length;i++){
      out.push([true, code[i]==='.'?DOT:DASH]);
      if (i<code.length-1) out.push([false,GAP_ELEM]);
    }
  }
  return out;
}
async function buildMorseBuffer(ctx, text, wpmToneHz=700, unitSec=0.09, vol=0.42){
  const units=textToUnits(normalizeText(text));
  const totalSec = units.reduce((s,u)=> s + u[1]*unitSec, 0);
  const length = Math.ceil(totalSec*ctx.sampleRate);
  const buf = ctx.createBuffer(1, length, ctx.sampleRate);
  const ch = buf.getChannelData(0);
  let t=0;
  function env(i, frames){ // simple attack/release
    const a=Math.min(0.002*ctx.sampleRate, frames*0.2);
    const r=Math.min(0.005*ctx.sampleRate, frames*0.2);
    if (i<a) return i/Math.max(1,a);
    if (i>frames-r) return Math.max(0,(frames-i)/Math.max(1,r));
    return 1;
  }
  for(const [tone, unitsN] of units){
    const frames = Math.floor(unitsN*unitSec*ctx.sampleRate);
    if (tone){
      for(let i=0;i<frames;i++){
        const e=env(i,frames);
        ch[t+i] = Math.sin(2*Math.PI*wpmToneHz*((t+i)/ctx.sampleRate)) * vol * e;
      }
    }
    t += frames;
  }
  return buf;
}

/* ================== Page flow (needle, stations, audio timing) ================== */
const needle=document.getElementById('needle'),
      readout=document.getElementById('readout'),
      statusEl=document.getElementById('status'),
      led=document.getElementById('led'),
      playBtn=document.getElementById('playBtn'),
      replayBtn=document.getElementById('replayBtn'),
      hintBtn=document.getElementById('hintBtn'),
      hintEl=document.getElementById('hint'),
      stationEl=document.getElementById('station');

const TUNING_MS = 2000; // tuning sweep length
const stationSequence = [
  {name:"KQX-112", at: 600},
  {name:"W9XYZ",  at: 1300},
  {name:"AD8AJ",  at: TUNING_MS+500}
];

async function requestFullscreen(){ try{
  const el=document.documentElement;
  if(el.requestFullscreen){await el.requestFullscreen();}
  else if(el.webkitRequestFullscreen){el.webkitRequestFullscreen();}
}catch(e){} }

function setNeedle(p){ const w=document.querySelector('.dial').clientWidth; const x=Math.max(0,Math.min(w-2,p*(w-2))); needle.style.transform=`translateX(${x}px)`; }
function animateTune(){ setNeedle(0.05); setTimeout(()=>setNeedle(0.35),450); setTimeout(()=>setNeedle(0.62),900); setTimeout(()=>setNeedle(0.88),1400); setTimeout(()=>setNeedle(0.67),1750); }
function scheduleStations(){ stationEl.textContent="—"; stationSequence.forEach(s=> setTimeout(()=>{ stationEl.textContent=s.name; }, s.at)); }

let morseBuffer=null;
async function ensureAudio(){
  if (!ac) ac = new (window.AudioContext||window.webkitAudioContext)();
  if (ac.state === 'suspended') await ac.resume();
  if (!morseBuffer){
    // Your final coordinates here (baked):
    const coords = "N 42 56.584 W 086 11.839";
    morseBuffer = await buildMorseBuffer(ac, coords, 700, 0.09, 0.42);
  }
}

function playMorse(){
  const src = ac.createBufferSource();
  src.buffer = morseBuffer;
  src.connect(ac.destination);
  src.start();
  src.onended = ()=>{
    statusEl.textContent = "Transmission lost.";
    replayBtn.disabled = false;
    playBtn.disabled = false;
    led.style.background = "#032c28";
    const hintMsg=document.createElement("div");
    hintMsg.style.marginTop="18px";
    hintMsg.style.padding="10px";
    hintMsg.style.borderTop="1px solid rgba(32,255,227,0.3)";
    hintMsg.style.color="#7bd4c9";
    hintMsg.style.fontFamily="ui-monospace, SFMono-Regular, Menlo, Consolas, monospace";
    hintMsg.style.fontSize="0.9rem";
    hintMsg.style.textAlign="center";
    hintMsg.style.opacity="0.85";
    hintMsg.innerHTML="<em>Among the trees, the signal hums quietly.<br>Not all transmitters broadcast. Some wait to be awakened.</em>";
    statusEl.parentElement.appendChild(hintMsg);
  };
}

function playSequence(){
  playBtn.disabled = true;
  statusEl.textContent = "Tuning…";
  led.style.background = "#22ffdd";
  animateTune();
  scheduleStations();
  startStatic();
  readout.textContent = "— Searching bands —";

  // Fade static just before the lock:
  setTimeout(()=> stopStatic(600), TUNING_MS + 250);

  // Lock + start Morse:
  setTimeout(async ()=>{
    readout.textContent = "— Signal lock —";
    statusEl.textContent = "Receiving Morse…";
    await ensureAudio();
    playMorse();
  }, TUNING_MS + 450);
}

playBtn.addEventListener('click', async ()=>{
  await requestFullscreen();
  playSequence();
});
replayBtn.addEventListener('click', async ()=>{
  await ensureAudio();
  playMorse();
  statusEl.textContent = "Replaying…";
});
hintBtn.addEventListener('click', ()=>{
  const on = hintEl.style.display==='block';
  hintEl.style.display = on?'none':'block';
  hintBtn.textContent = on?'Show Hint':'Hide Hint';
});

/* “Logged!” toast */
const toast=document.getElementById('toast');
document.getElementById('logBtn').addEventListener('click',()=>{
  toast.classList.add('show');
  setTimeout(()=>toast.classList.remove('show'), 2200);
});
</script>
</body>
</html>
