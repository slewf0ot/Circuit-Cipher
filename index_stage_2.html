<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Ciphered Circuit — Stage 2 Cryptex (Portrait + Static + Blank Wheels)</title>
<style>
  :root{
    --bg:#0a0f14; --panel:#0d1218; --primary:#20ffe3; --accent:#ff5d73; --muted:#7bd4c9; --glow:#24ffd6;
    --wheel: clamp(56px, 17.5vw, 92px);
    --gap: clamp(6px, 2.6vw, 14px);
    --btn-pad: clamp(8px, 2.8vw, 12px);
    --slot-fs: clamp(1.05rem, 6vw, 1.6rem);
  }
  html,body{margin:0;background:var(--bg);color:#e8fff9;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
  .wrap{max-width:900px;margin:0 auto;padding:16px}
  .head{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;gap:10px;flex-wrap:wrap}
  .title{color:var(--primary);letter-spacing:.08em;text-shadow:0 0 8px rgba(32,255,227,.35);margin:0;font-size:clamp(1.05rem, 3.8vw, 1.35rem)}
  .panel{background:linear-gradient(145deg,var(--panel),#0a1017);border:1px solid rgba(32,255,227,.25);border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,.5),inset 0 0 24px rgba(32,255,227,.06);padding:14px;transition:box-shadow .35s ease, border-color .35s ease}
  .panel.flash{box-shadow:0 0 30px rgba(36,255,214,.5), inset 0 0 40px rgba(36,255,214,.15); border-color: rgba(36,255,214,.6)}
  .cryptex{display:flex;flex-wrap:nowrap;justify-content:center;align-items:center;gap:var(--gap);margin:12px 0 6px;overflow:hidden}
  .wheel{display:flex;flex-direction:column;align-items:center;background:#0b1218;border:1px solid rgba(32,255,227,.25);border-radius:12px;padding:8px;width:var(--wheel)}
  .wheel button{border:1px solid rgba(32,255,227,.5);background:linear-gradient(160deg,rgba(32,255,227,.18),rgba(32,255,227,.06));color:#bafff3;border-radius:8px;padding:6px var(--btn-pad);cursor:pointer;font-weight:700;line-height:1}
  .slot{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;font-size:var(--slot-fs);color:#dffef7;margin:6px 0;height:2rem;display:flex;align-items:center;justify-content:center;opacity:.95}
  .slot.blank{color:#6abfb4; opacity:.7}
  .actions{display:flex;gap:10px;justify-content:center;flex-wrap:wrap;margin-top:10px}
  .btn{border:1px solid rgba(32,255,227,.6);background:linear-gradient(160deg,rgba(32,255,227,.18),rgba(32,255,227,.06));color:#bafff3;padding:8px var(--btn-pad);border-radius:999px;cursor:pointer;text-decoration:none;font-weight:800}
  .msg{text-align:center;color:#9feee2;margin-top:10px;min-height:1.2rem;font-size:.95rem}
  .reveal{display:none;margin-top:12px;text-align:center;border-top:1px solid rgba(32,255,227,.3);padding-top:10px;color:#aafff1}
  .tag{display:inline-block;margin-top:6px;padding:4px 8px;border:1px dashed rgba(32,255,227,.4);border-radius:8px;color:#9feee2;font-size:.9rem}
  @media (max-width: 360px){
    :root{ --wheel: 54px; --gap: 6px; --slot-fs: 1rem; }
  }
  .toast{position:fixed;left:50%;top:14px;transform:translateX(-50%) scale(.95);background:#0c161a;border:1px solid rgba(118,255,168,.6);color:#dcffef;
    padding:10px 14px;border-radius:12px;box-shadow:0 14px 30px rgba(0,0,0,.5),0 0 30px rgba(118,255,168,.25);
    opacity:0;pointer-events:none;transition:.35s ease; z-index:9999}
  .toast.show{opacity:1;transform:translateX(-50%) scale(1)}
</style>
</head>
<body>
<div class="wrap">
  <div class="head">
    <h2 class="title">CIPHERED CIRCUIT // STAGE 2 — CRYPTEX</h2>
    <a class="btn" href="https://slewf0ot.github.io/Circuit-Cipher/index_stage_3.html?stage=Stage%202" target="_blank" rel="noopener" id="logTop">✎ Log Stage 2</a>
  </div>

  <div class="panel" id="panel">
    <div class="cryptex" id="cryptex"></div>

    <div class="actions">
      <button class="btn" id="submitBtn">Submit</button>
      <button class="btn" id="hintBtn">Play Hint</button>
      <a class="btn" href="https://slewf0ot.github.io/Circuit-Cipher/index_stage_3.html?stage=Stage%202" target="_blank" rel="noopener" id="logBtn">Log Stage 2</a>
    </div>

    <div class="msg" id="msg"></div>

    <div class="reveal" id="reveal">
      <div class="tag">SIGNAL LOCK // DECRYPTED</div>
      <h3 style="margin:8px 0 6px;">Final Coordinates</h3>
      <div id="final" style="font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;font-size:1.15rem;text-shadow:0 0 10px rgba(32,255,227,.5)">
        N 42° 56.944′ W 086° 11.372′
      </div>
      <div style="margin-top:8px;">
        <a class="btn" href="https://slewf0ot.github.io/Circuit-Cipher/index_stage_3.html?stage=Final" target="_blank" rel="noopener">✎ Log Final</a>
      </div>
    </div>
  </div>
</div>

<div class="toast" id="toast">Logbook opened in a new tab.</div>

<script>
/* ======= 5 wheels, no wrap, blank by default ======= */
const alphabet = "ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789".split("");
const solution = "AD8AJ";
const root = document.getElementById('cryptex');
const wheels = [];

/* Make a wheel:
   - idx = -1 means BLANK (display “—”)
   - first ▲ sets to A, ▼ sets to last character (9), then cycles */
function makeWheel(initial){
  let idx = -1; // blank
  const el = document.createElement('div'); el.className='wheel';
  const up = document.createElement('button'); up.textContent='▲';
  const slot = document.createElement('div'); slot.className='slot blank'; slot.textContent = '—';
  const down = document.createElement('button'); down.textContent='▼';

  function render(){
    if (idx < 0){ slot.textContent = '—'; slot.classList.add('blank'); }
    else { slot.textContent = alphabet[idx]; slot.classList.remove('blank'); }
  }
  up.addEventListener('click',()=>{
    if (idx < 0) idx = 0; else idx=(idx+1)%alphabet.length;
    render();
  });
  down.addEventListener('click',()=>{
    if (idx < 0) idx = alphabet.length-1; else idx=(idx-1+alphabet.length)%alphabet.length;
    render();
  });

  el.appendChild(up); el.appendChild(slot); el.appendChild(down);
  root.appendChild(el);

  return { get: ()=> (idx<0 ? '' : alphabet[idx]) };
}

// Build five blank wheels
for (let i=0;i<5;i++) wheels.push(makeWheel("A"));

const msg = document.getElementById('msg');
const panel = document.getElementById('panel');
const reveal = document.getElementById('reveal');

/* ======= Submit: static burst then reveal ======= */
document.getElementById('submitBtn').addEventListener('click', async ()=>{
  const guess = wheels.map(w=>w.get()).join("");
  if(guess === solution){
     msg.textContent = "Correct — acquiring signal lock…";
     await radioStaticBurst(520);      // play short static
     panel.classList.add('flash');     // glow during lock
     setTimeout(()=>panel.classList.remove('flash'), 800);
     reveal.style.display = 'block';
     msg.textContent = "Correct — final coordinates revealed!";
  } else {
     msg.textContent = "Incorrect attempt. Keep tuning.";
  }
});

/* ======= Radio-style static burst (WebAudio) ======= */
async function radioStaticBurst(ms=500){
  try{
    const ctx = new (window.AudioContext||window.webkitAudioContext)();
    const dur = Math.max(0.05, ms/1000);
    const buffer = ctx.createBuffer(1, ctx.sampleRate*dur, ctx.sampleRate);
    const data = buffer.getChannelData(0);
    // white noise with quick fade
    for (let i=0;i<data.length;i++){
      const t = i / data.length;
      const env = t<0.1 ? t/0.1 : (t>0.85 ? Math.max(0,(1-t)/0.15) : 1);
      data[i] = (Math.random()*2-1) * 0.35 * env;
    }
    // bandpass filter for radio flavor
    const src = ctx.createBufferSource(); src.buffer = buffer;
    const bp = ctx.createBiquadFilter(); bp.type='bandpass'; bp.frequency.value = 1200; bp.Q.value = 1.0;
    const g  = ctx.createGain(); g.gain.value = 0.9;
    src.connect(bp); bp.connect(g); g.connect(ctx.destination);
    src.start();
    await new Promise(r=> setTimeout(r, ms));
  }catch(e){}
}

/* ======= AD8AJ Morse hint (WebAudio) ======= */
const MORSE = {
  A:'.-',B:'-...',C:'-.-.',D:'-..',E:'.',F:'..-.',G:'--.',H:'....',I:'..',J:'.---',
  K:'-.-',L:'.-..',M:'--',N:'-.',O:'---',P:'.--.',Q:'--.-',R:'.-.',S:'...',T:'-',
  U:'..-',V:'...-',W:'.--',X:'-..-',Y:'-.--',Z:'--..',
  0:'-----',1:'.----',2:'..---',3:'...--',4:'....-',5:'.....',6:'-....',7:'--...',8:'---..',9:'----.'
};
function textToUnits(t){
  const DOT=1, DASH=3, GAP_ELEM=1, GAP_CHAR=3, GAP_WORD=7;
  const out=[]; let first=true;
  for(const raw of t.toUpperCase()){
    const ch = raw;
    if (ch===' '){ out.push([false,GAP_WORD]); first=true; continue; }
    const code=MORSE[ch]; if(!code){ if(!first) out.push([false,GAP_CHAR]); first=false; continue; }
    if(!first) out.push([false,GAP_CHAR]); first=false;
    for(let i=0;i<code.length;i++){
      out.push([true, code[i]==='.'?DOT:DASH]);
      if (i<code.length-1) out.push([false,GAP_ELEM]);
    }
  }
  return out;
}
async function playMorseHint(text){
  try{
    const ctx = new (window.AudioContext||window.webkitAudioContext)();
    const unit = 0.09, hz=700, vol=0.4;
    const units=textToUnits(text);
    const length = Math.ceil(units.reduce((s,u)=>s+u[1]*unit,0)*ctx.sampleRate);
    const buf = ctx.createBuffer(1, length, ctx.sampleRate);
    const ch = buf.getChannelData(0);
    let t=0;
    function env(i,n){ const a=Math.min(0.002*ctx.sampleRate,n*0.2), r=Math.min(0.005*ctx.sampleRate,n*0.2); if(i<a) return i/Math.max(1,a); if(i>n-r) return Math.max(0,(n-i)/Math.max(1,r)); return 1; }
    for(const [tone, u] of units){
      const frames = Math.floor(u*unit*ctx.sampleRate);
      if (tone){
        for(let i=0;i<frames;i++){
          ch[t+i] = Math.sin(2*Math.PI*hz*((t+i)/ctx.sampleRate)) * vol * env(i,frames);
        }
      }
      t+=frames;
    }
    const src = ctx.createBufferSource(); src.buffer=buf; src.connect(ctx.destination); src.start();
  }catch(e){}
}
document.getElementById('hintBtn').addEventListener('click',()=> playMorseHint('AD8AJ'));

/* ======= “Logged!” toast ======= */
const toast=document.getElementById('toast');
function showToast(){ toast.classList.add('show'); setTimeout(()=>toast.classList.remove('show'), 2200); }
document.getElementById('logBtn').addEventListener('click', showToast);
document.getElementById('logTop').addEventListener('click', showToast);
</script>
</body>
</html>
